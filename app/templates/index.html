<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>TodoList</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-4xl bg-white p-6 rounded-2xl shadow-lg">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">ğŸ“‹ TodoList</h1>
            <button onclick="openModal()" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">
                + æ–°å»ºä»»åŠ¡
            </button>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="flex items-center mb-4">
            <input id="searchInput" type="text" placeholder="æœç´¢ä»»åŠ¡..." class="w-full p-2 border rounded-xl"
                onkeyup="filterTasks()">
        </div>

        <!-- Todo åˆ—è¡¨ -->
        <ul id="todoList" class="space-y-2">
            <!-- JS åŠ¨æ€æ’å…¥ -->
        </ul>

        <!-- åˆ†é¡µ -->
        <div class="flex justify-between items-center mt-4">
            <button onclick="prevPage()" class="px-3 py-1 bg-gray-200 rounded-xl hover:bg-gray-300">ä¸Šä¸€é¡µ</button>
            <span id="pageInfo" class="text-gray-600">ç¬¬ 1 é¡µ</span>
            <button onclick="nextPage()" class="px-3 py-1 bg-gray-200 rounded-xl hover:bg-gray-300">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-2xl w-96 shadow-lg">
            <h2 class="text-lg font-bold mb-4">æ–°å»ºä»»åŠ¡</h2>
            <input id="newTaskInput" type="text" placeholder="è¯·è¾“å…¥ä»»åŠ¡..." class="w-full p-2 border rounded-xl mb-4">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-xl">å–æ¶ˆ</button>
                <button onclick="addTask()"
                    class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <script>
        var currentPage = 1, totalPages = 0;

        function renderTasks(page = currentPage, plan = "") {
            fetch("/tasks?page=" + page + "&plan=" + plan, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            })
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById("todoList");
                    list.innerHTML = "";
                    data.data.forEach((task, index) => {
                        const li = document.createElement("li");
                        li.className = "p-3 bg-gray-50 border rounded-xl flex justify-between items-center hover:bg-gray-100";

                        // å·¦ä¾§ï¼šä»»åŠ¡æ–‡æœ¬ + çŠ¶æ€
                        const textDiv = document.createElement("div");
                        textDiv.innerHTML = `
                        <span class="${task.state ? 'line-through text-gray-400' : ''}">${task.plan}</span>
                        <span class="ml-2 text-sm ${task.state ? 'text-green-600' : 'text-red-500'}">
                            ${task.state ? 'âœ” å·²å®Œæˆ' : 'âœ˜ æœªå®Œæˆ'}
                        </span>
                        `;

                        // å³ä¾§ï¼šæ“ä½œæŒ‰é’®
                        const btnDiv = document.createElement("div");
                        btnDiv.className = "space-x-2";
                        btnDiv.innerHTML = `
                        <button onclick="toggleDone(${task.id})" class="px-2 py-1 text-sm rounded-lg ${task.state ? 'bg-yellow-400 hover:bg-yellow-500' : 'bg-green-500 hover:bg-green-600'} text-white">
                            ${task.state ? 'æ’¤é”€' : 'å®Œæˆ'}
                        </button>
                        <button onclick="deleteTask(${task.id})" class="px-2 py-1 text-sm rounded-lg bg-red-500 hover:bg-red-600 text-white">åˆ é™¤</button>
                        `;

                        li.appendChild(textDiv);
                        li.appendChild(btnDiv);
                        list.appendChild(li);

                        currentPage = data.page;
                        totalPages = data.pages;
                    });
                    document.getElementById("pageInfo").innerText = `ç¬¬ ${data.page} é¡µ / å…± ${data.pages || 1} é¡µ`;
                });
        }

        function filterTasks(page = currentPage) {
            var search = document.getElementById("searchInput").value.toLowerCase();
            renderTasks(page, search);
        }

        function prevPage(page = currentPage) {
            if (currentPage > 1) {
                renderTasks(page - 1);
            }
        }

        function nextPage(page = currentPage, total = totalPages) {
            if (page < totalPages) {
                renderTasks(page + 1);
            }
        }

        function openModal() {
            document.getElementById("modal").classList.remove("hidden");
        }

        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        function addTask() {
            const input = document.getElementById("newTaskInput");
            var search = document.getElementById("searchInput");

            if (input.value.trim()) {
                fetch("/tasks", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ plan: input.value })
                })
                    .then(res => res.json())
                    .then(data => {
                        input.value = "";
                        search.value = "";
                        closeModal();
                        renderTasks(currentPage);
                    });
            }
        }

        function toggleDone(task_id) {
            var search = document.getElementById("searchInput").value.toLowerCase();
            fetch("/tasks", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ task_id: task_id })
            })
                .then(res => res.json())
                .then(data => {
                    renderTasks(currentPage, search); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                });
        }

        function deleteTask(task_id) {
            var search = document.getElementById("searchInput").value.toLowerCase();
            fetch("/tasks", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ task_id: task_id })
            })
                .then(res => res.json())
                .then(data => {
                    renderTasks(currentPage, search); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                });
        }

        // åˆå§‹åŒ–æ¸²æŸ“
        renderTasks(currentPage);
    </script>
</body>

</html>